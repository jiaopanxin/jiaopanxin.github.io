<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Ansible_5_ansible变量 - Joken Blog</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Joken" /><meta name="description" content="第 5 章 Ansible 变量 1 2 我们在PlayBook一节中，将PlayBook类比成了Linux中的shell。那么它作为一门Ansible特殊的语言，肯" /><meta name="keywords" content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.62.0 with theme even" />


<link rel="canonical" href="https://jiaopanxin.github.io/post/ansible/ansible_5_ansible%E5%8F%98%E9%87%8F/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<link href="/dist/even.c2a46f00.min.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Ansible_5_ansible变量" />
<meta property="og:description" content="第 5 章 Ansible 变量 1 2 我们在PlayBook一节中，将PlayBook类比成了Linux中的shell。那么它作为一门Ansible特殊的语言，肯" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://jiaopanxin.github.io/post/ansible/ansible_5_ansible%E5%8F%98%E9%87%8F/" />
<meta property="article:published_time" content="2019-12-25T20:14:02+08:00" />
<meta property="article:modified_time" content="2019-12-25T20:14:02+08:00" />
<meta itemprop="name" content="Ansible_5_ansible变量">
<meta itemprop="description" content="第 5 章 Ansible 变量 1 2 我们在PlayBook一节中，将PlayBook类比成了Linux中的shell。那么它作为一门Ansible特殊的语言，肯">
<meta itemprop="datePublished" content="2019-12-25T20:14:02&#43;08:00" />
<meta itemprop="dateModified" content="2019-12-25T20:14:02&#43;08:00" />
<meta itemprop="wordCount" content="4271">



<meta itemprop="keywords" content="ansible," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Ansible_5_ansible变量"/>
<meta name="twitter:description" content="第 5 章 Ansible 变量 1 2 我们在PlayBook一节中，将PlayBook类比成了Linux中的shell。那么它作为一门Ansible特殊的语言，肯"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Joken Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">首页</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">归档</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">分类</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">标签</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">关于我</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Joken Blog</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">首页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">归档</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">分类</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">标签</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">关于我</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Ansible_5_ansible变量</h1>

      <div class="post-meta">
        <span class="post-time"> 2019-12-25 20:14 </span>
        <div class="post-category">
            <a href="/categories/ansible/"> ansible </a>
            </div>
          <span class="more-meta"> 约 4271 字 </span>
          <span class="more-meta"> 预计阅读 9 分钟 </span>
        <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次阅读 </span>
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h4 id="-5--ansible-">第 5 章 Ansible 变量</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">我们在PlayBook一节中，将PlayBook类比成了Linux中的shell。那么它作为一门Ansible特殊的语言，肯定要涉及到变量定义、控制结构的使用等特性。在这一节中主要讨论变量的定义和使用。

</code></pre></td></tr></table>
</div>
</div><h5 id="heading">变量命名规则</h5>
<p><strong>变量的名字由字母、下划线和数字组成，以字母开头。</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">如下变量命名为正确:
good_a  OK
ok_b    OK
如下变量命名为错误:
_aaa    FAIL
2_bb    FAIL

</code></pre></td></tr></table>
</div>
</div><p><strong>保留关键字不能作为变量名称</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">add, append, as_integer_ratio, bit_length, capitalize, center, clear, conjugate, copy, count, decode, denominator, difference, difference_update, discard, encode, endswith, expandtabs, extend, find, format, fromhex, fromkeys, get, has_key, hex, imag, index, insert, intersection, intersection_update, isalnum, isalpha, isdecimal, isdigit, isdisjoint, is_integer, islower, isnumeric, isspace, issubset, issuperset, istitle, isupper, items, iteritems, iterkeys, itervalues, join, keys, ljust, lower, lstrip, numerator, partition, pop, popitem, real, remove, replace, reverse, rfind, rindex, rjust, rpartition, rsplit, rstrip, setdefault, sort, split, splitlines, startswith, strip, swapcase, symmetric_difference, symmetric_difference_update, title, translate, union, update, upper, values, viewitems, viewkeys, viewvalues, zfill

</code></pre></td></tr></table>
</div>
</div><h5 id="heading-1">变量类型</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">根据变量的作用范围大体的将变量分为: 全局变量、剧本变量、资产变量。但只是一个比较粗糙的划分，不能囊括Ansible 中的所有变量。下面将分别从这三种变量入手，去介绍变量的使用

</code></pre></td></tr></table>
</div>
</div><h5 id="heading-2">全局变量</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">全局变量，是我们使用ansible 或使用ansible-playbook 时，手动通过 -e 参数传递给Ansible 的变量。
通过ansible 或 ansible-playbook 的 help 帮助, 可以获取具体格式使用方式:
# ansible -h |grep var
  -e EXTRA_VARS, --extra-vars=EXTRA_VARS
                        set additional variables as key=value or YAML/JSON

# ansible-playbook  -h |grep var
  -e EXTRA_VARS, --extra-vars=EXTRA_VARS
                        set additional variables as key=value or YAML/JSON

</code></pre></td></tr></table>
</div>
</div><p><strong>Example</strong></p>
<p>传递普通的key=value 的形式</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># ansible all -i localhost, -m debug -a &#34;msg=&#39;my key is {{ key }}&#39;&#34; -e &#34;key=value&#34;

</code></pre></td></tr></table>
</div>
</div><p>传递一个YAML/JSON 的形式(注意不管是YAML还是JSON，它们的最终格式一定要是一个字典)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># cat a.json
{&#34;name&#34;:&#34;qfedu&#34;,&#34;type&#34;:&#34;school&#34;}

</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># ansible all -i localhost, -m debug -a &#34;msg=&#39;name is {{ name  }}, type is {{ type }}&#39;&#34; -e @a.json

</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># cat a.yml
---
name: qfedu
type: school
...

</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># ansible all -i localhost, -m debug -a &#34;msg=&#39;name is {{ name  }}, type is {{ type }}&#39;&#34; -e @a.yml

</code></pre></td></tr></table>
</div>
</div><h5 id="heading-3">剧本变量</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">此种变量和PlayBook 有关，定义在PlayBook中的。它的定义方式有多种，我们这里介绍两种最常用的定义方式。

</code></pre></td></tr></table>
</div>
</div><p><strong>通过PLAY 属性 vars 定义</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">---
- name: test play vars 
  hosts: all
  vars:
    user: lilei
    home: /home/lilei

</code></pre></td></tr></table>
</div>
</div><p><strong>通过PLAY 属性 vars_files 定义</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># 当通过vars属性定义的变量很多时，这个Play就会感觉特别臃肿。此时我们可以将变量单独从Play中抽离出来，
# 形成单独的YAML 文件。
---
- name: test play vars
  hosts: all
  vars_files:
    - vars/users.yml

</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># cat vars/users.yml
---
user: lilei
home: /home/lilei

</code></pre></td></tr></table>
</div>
</div><p><strong>如何在PlayBook中使用这些变量</strong></p>
<p>在PlayBook中使用变量时，使用 <strong>{{ 变量名 }}</strong> 来使用变量</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">---
- name: test play vars 
  hosts: all
  vars:
    user: lilei
    home: /home/lilei
  tasks:
    - name: create the user {{ user }}
      user:
        name: &#34;{{ user }}&#34;
        home: &#34;{{ home }}&#34;

</code></pre></td></tr></table>
</div>
</div><p><strong>在PlayBook中使用变量的注意点</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">---
# 这里我们将上面的Playbook中引用变量的部分进行修改，去掉了双引号。
- name: test play vars 
  hosts: all
  vars:
    user: lilei
    home: /home/lilei
  tasks:
    - name: create the user {{ user }}
      user:
        # 注意这里将 &#34;{{ user }}&#34; 改成了 {{ user }}
        name: {{ user }}
        home: &#34;{{ home }}”

</code></pre></td></tr></table>
</div>
</div><p>执行以上的PlayBook 时，会出现以下错误</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">The offending line appears to be:

      user:
        name: {{ user }}
               ^ here
We could be wrong, but this one looks like it might be an issue with
missing quotes.  Always quote template expression brackets when they
start a value. For instance:

    with_items:
      - {{ foo }}

Should be written as:

    with_items:
      - &#34;{{ foo }}&#34;

</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">这样错误的主要原因是PlayBook 是YAML 的文件格式， 当Ansible 分析YAML 文件时，有可能会误认为类似
name: {{ user }} 是一个字典的开始。因此加针对变量的使用，加上了双引号，避免Ansible错误解析。

</code></pre></td></tr></table>
</div>
</div><h5 id="heading-4">资产变量</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">在第二章中我们学习了资产。资产共分为静态资产和动态资产。这一节中学习的资产变量，就是和资产紧密相关的一种变量。资产变量分为主机变量和组变量，分别针对资产中的单个主机和组。

</code></pre></td></tr></table>
</div>
</div><p><strong>主机变量</strong></p>
<p>以下资产中，定义了一个主机变量 lilei ，此变量只针对 192.168.122.129 这台服务器有效。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># cat inventoryandhostvars
[web-servers]
192.168.122.129 user=lilei
192.168.122.131

</code></pre></td></tr></table>
</div>
</div><p><strong>验证</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">// 获取定义的变量值
# ansible 192.168.122.129  -i inventoryandhostvars  -m debug -a &#34;var=user&#34;
192.168.122.129 | SUCCESS =&gt; {
    &#34;user&#34;: &#34;lilei&#34;
}

// 未获取到定义的变量值，因为 lilei 这个变量针对 192.168.122.131 主机无效。
# ansible 192.168.122.131  -i inventoryandhostvars  -m debug -a &#34;var=user&#34;
192.168.122.131 | SUCCESS =&gt; {
    &#34;user&#34;: &#34;VARIABLE IS NOT DEFINED!&#34;
}

</code></pre></td></tr></table>
</div>
</div><p><strong>组变量</strong></p>
<p>以下资产中，定义了一个组变量home ，此变量将针对web-servers 这个主机组中的所有服务器有效</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># cat inventoryandgroupvars
[web-servers]
192.168.122.129 user=lilei
192.168.122.131

[web-servers:vars]
home=&#34;/home/lilei&#34;

</code></pre></td></tr></table>
</div>
</div><p><strong>验证</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">// user 在资产中定义的是主机变量， 所有在主机 192.168.122.131 中未获取到变量user 值
# ansible web-servers  -i inventoryandgroupvars  -m debug -a &#34;var=user&#34;
192.168.122.129 | SUCCESS =&gt; {
    &#34;user&#34;: &#34;lilei&#34;
}
192.168.122.131 | SUCCESS =&gt; {
    &#34;user&#34;: &#34;VARIABLE IS NOT DEFINED!&#34;
}
// home 是 web-servers 的组变量，会针对这个组内的所有服务器生效。
# ansible web-servers  -i inventoryandgroupvars  -m debug -a &#34;var=home&#34;
192.168.122.129 | SUCCESS =&gt; {
    &#34;home&#34;: &#34;/home/lilei&#34;
}
192.168.122.131 | SUCCESS =&gt; {
    &#34;home&#34;: &#34;/home/lilei&#34;
}

</code></pre></td></tr></table>
</div>
</div><p><strong>主机变量 VS 组变量</strong></p>
<p>当主机变量和组变量在同一个资产中发生重名的情况，会有什么效果呢?</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># cat inventory_v2
[web-servers]
192.168.122.129 user=lilei
192.168.122.131

[web-servers:vars]
user=cat

</code></pre></td></tr></table>
</div>
</div><p><strong>验证</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">// 在资产中定义了主机变量和组变量 user, 此时发现 192.168.122.129 这台机器的主机变量 user 的优先级
// 优先于 组变量user 使用。
# ansible web-servers  -i inventory_v2  -m debug -a &#34;var=user&#34;
192.168.122.129 | SUCCESS =&gt; {
    &#34;user&#34;: &#34;lilei&#34;
}
192.168.122.131 | SUCCESS =&gt; {
    &#34;user&#34;: &#34;cat&#34;
}

</code></pre></td></tr></table>
</div>
</div><p><strong>变量继承</strong></p>
<p>在介绍资产时说过资产的继承，那么变量是否也存在继承关系呢?</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># cat inventory_v3
[web-servers]
192.168.122.129

[db-servers]
192.168.122.131

[all-servers]
[all-servers:children]
db-servers
web-servers

[all-servers:vars]
user=lilei

</code></pre></td></tr></table>
</div>
</div><p><strong>验证</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">// 在资产继承的同时，对应的变量也发生了继承
# ansible all-servers  -i inventory_v3  -m debug -a &#34;var=user&#34;
192.168.122.131 | SUCCESS =&gt; {
    &#34;user&#34;: &#34;lilei&#34;
}
192.168.122.129 | SUCCESS =&gt; {
    &#34;user&#34;: &#34;lilei&#34;
}
# ansible db-servers  -i inventory_v3  -m debug -a &#34;var=user&#34;
192.168.122.131 | SUCCESS =&gt; {
    &#34;user&#34;: &#34;lilei&#34;
}
# ansible web-servers  -i inventory_v3  -m debug -a &#34;var=user&#34;
192.168.122.129 | SUCCESS =&gt; {
    &#34;user&#34;: &#34;lilei&#34;
}

</code></pre></td></tr></table>
</div>
</div><h5 id="facts">Facts变量</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">Facts变量不包含在前文中介绍的全局变量、剧本变量及资产变量之内。Facts变量不需要我们人为去声明变量名及赋值。它的声明和赋值完全有Ansible 中的Facts模块帮我们完成。类似于资产变量中的主机变量，它收集了有关被管理服务器的操作系统的版本、服务器的IP地址、主机名，磁盘的使用情况、CPU个数、内存大小等等有关被管理服务器的私有信息。假如我们足够细心的话，在每次PlayBook运行的时候都会发现在PlayBook执行前都会有一个Gathering Facts的过程。这个过程就是收集被管理服务器的Facts信息过程。

</code></pre></td></tr></table>
</div>
</div><p><strong>手动收集Facts 变量</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># ansible all -i localhost, -c local -m setup
localhost | SUCCESS =&gt; {
    &#34;ansible_facts&#34;: {
        &#34;ansible_all_ipv4_addresses&#34;: [
            &#34;192.168.122.130&#34;
        ],
        &#34;ansible_all_ipv6_addresses&#34;: [
            &#34;fe80::20c:29ff:fede:b5b&#34;
        ],
        &#34;ansible_apparmor&#34;: {
            &#34;status&#34;: &#34;disabled&#34;
        },
        &#34;ansible_architecture&#34;: &#34;x86_64&#34;,
        &#34;ansible_bios_date&#34;: &#34;07/02/2015&#34;,
        &#34;ansible_bios_version&#34;: &#34;6.00&#34;,
        &#34;ansible_cmdline&#34;: {
            &#34;KEYBOARDTYPE&#34;: &#34;pc&#34;,
            &#34;KEYTABLE&#34;: &#34;us&#34;,
            &#34;LANG&#34;: &#34;en_US.UTF-8&#34;,
            &#34;SYSFONT&#34;: &#34;latarcyrheb-sun16&#34;,
            &#34;nomodeset&#34;: true,
            &#34;quiet&#34;: true,
            &#34;rd_LVM_LV&#34;: &#34;vg_mouse00/lv_root&#34;,
            &#34;rd_NO_DM&#34;: true,
            &#34;rd_NO_LUKS&#34;: true,
            &#34;rd_NO_MD&#34;: true,
            &#34;rhgb&#34;: true,
            &#34;ro&#34;: true,
            &#34;root&#34;: &#34;/dev/mapper/vg_mouse00-lv_root&#34;
        },
    ...
    ...
    ...

</code></pre></td></tr></table>
</div>
</div><p><strong>过滤Facts</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">通过刚刚的手动收集Facts，我们发现facts 信息量很大。 能不能有针对性的显示我们想要的信息呢?
可以通过使用Facts 模块中的filter参数去过滤我们想要的信息。

</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">// 比如我想要服务器的内存情况信息
# ansible all -i localhost, -m setup -a &#34;filter=*memory*&#34; -c local
localhost | SUCCESS =&gt; {
    &#34;ansible_facts&#34;: {
        &#34;ansible_memory_mb&#34;: {
            &#34;nocache&#34;: {
                &#34;free&#34;: 508,
                &#34;used&#34;: 473
            },
            &#34;real&#34;: {
                &#34;free&#34;: 59,
                &#34;total&#34;: 981,
                &#34;used&#34;: 922
            },
            &#34;swap&#34;: {
                &#34;cached&#34;: 0,
                &#34;free&#34;: 1981,
                &#34;total&#34;: 1983,
                &#34;used&#34;: 2
            }
        }
    },
    &#34;changed&#34;: false
}
// 比如想要服务器的磁盘挂载情况
# ansible all -i localhost, -m setup -a &#34;filter=*mount*&#34; -c local
localhost | SUCCESS =&gt; {
    &#34;ansible_facts&#34;: {
        &#34;ansible_mounts&#34;: [
            {
                &#34;device&#34;: &#34;/dev/mapper/vg_mouse00-lv_root&#34;,
                &#34;fstype&#34;: &#34;ext4&#34;,
                &#34;mount&#34;: &#34;/&#34;,
                &#34;options&#34;: &#34;rw&#34;,
                &#34;size_available&#34;: 5795786752,
                &#34;size_total&#34;: 18435350528,
                &#34;uuid&#34;: &#34;N/A&#34;
            },
            {
                &#34;device&#34;: &#34;/dev/sda1&#34;,
                &#34;fstype&#34;: &#34;ext4&#34;,
                &#34;mount&#34;: &#34;/boot&#34;,
                &#34;options&#34;: &#34;rw&#34;,
                &#34;size_available&#34;: 442216448,
                &#34;size_total&#34;: 499355648,
                &#34;uuid&#34;: &#34;N/A&#34;
            }
        ]
    },
    &#34;changed&#34;: false
}

</code></pre></td></tr></table>
</div>
</div><p><strong>如何在PlayBook中去使用Facts 变量</strong></p>
<p>默认情况下，在执行PlayBook的时候，它会去自动的获取每台被管理服务器的facts信息。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">---
- name: a play example
  hosts: all
  remote_user: root
  tasks:
    - name: install nginx package
      yum: name=nginx state=present
    - name: copy nginx.conf to remote server
      copy: src=nginx.conf dest=/etc/nginx/nginx.conf
    - name: start nginx server
      service:
        name: nginx
        enabled: true
        state: started

</code></pre></td></tr></table>
</div>
</div><p><strong>执行</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># ansible-playbook   myplaybook.yml

PLAY [a play example] ***************************************************************************************************************************************************************
# 执行PLAYBOOK时，自动收集facts 信息
TASK [Gathering Facts] **************************************************************************************************************************************************************
ok: [192.168.122.131]
ok: [192.168.122.129]

TASK [install nginx package] ********************************************************************************************************************************************************
ok: [192.168.122.129]
ok: [192.168.122.131]
......
......

</code></pre></td></tr></table>
</div>
</div><p>可以像使用其他变量一样，去使用facts 变量</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">---
- name: print facts variable
  hosts: all
  tasks:
   - name: print facts variable
     debug:
       msg: &#34;The default IPV4 address is {{ ansible_default_ipv4.address }}&#34;

</code></pre></td></tr></table>
</div>
</div><p><strong>如何在PlayBook中去关闭Facts 变量的获取</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">若在整个PlayBook 的执行过程中，完全未使用过Facts 变量，此时我们可以将其关闭，以加快PlayBook的执行速度。

</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">---
- name: a play example
  hosts: all
  # 关闭 facts 变量收集功能
  gather_facts: no
  remote_user: root
  tasks:
    - name: install nginx package
      yum: name=nginx state=present
    - name: copy nginx.conf to remote server
      copy: src=nginx.conf dest=/etc/nginx/nginx.conf
    - name: start nginx server
      service:
        name: nginx
        enabled: true
        state: started

</code></pre></td></tr></table>
</div>
</div><p><strong>执行</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># ansible-playbook   myplaybook2.yml

PLAY [a play example] ***************************************************************************************************************************************************************

TASK [install nginx package] ********************************************************************************************************************************************************
ok: [192.168.122.129]
ok: [192.168.122.131]

TASK [copy nginx.conf to remote server] *********************************************************************************************************************************************
ok: [192.168.122.131]
ok: [192.168.122.129]

TASK [start nginx server] ***********************************************************************************************************************************************************
ok: [192.168.122.131]

</code></pre></td></tr></table>
</div>
</div><h5 id="heading-5">注册变量</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">往往用于保存一个task任务的执行结果, 以便于debug时使用。或者将此次task任务的结果作为条件，去判断是否去执行其他task任务。注册变量在PlayBook中通过register关键字去实现。

</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="o">--</span><span class="o">-</span>
<span class="o">-</span> <span class="nx">name</span><span class="p">:</span> <span class="nx">install</span> <span class="nx">a</span> <span class="kn">package</span> <span class="nx">and</span> <span class="nx">print</span> <span class="nx">the</span> <span class="nx">result</span>
  <span class="nx">hosts</span><span class="p">:</span> <span class="nx">all</span>
  <span class="nx">remote_user</span><span class="p">:</span> <span class="nx">root</span>
  <span class="nx">tasks</span><span class="p">:</span>
    <span class="o">-</span> <span class="nx">name</span><span class="p">:</span> <span class="nx">install</span> <span class="nx">nginx</span> <span class="kn">package</span>
      <span class="nx">yum</span><span class="p">:</span> <span class="nx">name</span><span class="p">=</span><span class="nx">nginx</span> <span class="nx">state</span><span class="p">=</span><span class="nx">present</span>
      <span class="nx">register</span><span class="p">:</span> <span class="nx">install_result</span>
    <span class="o">-</span> <span class="nx">name</span><span class="p">:</span> <span class="nx">print</span> <span class="nx">result</span>
      <span class="nx">debug</span><span class="p">:</span> <span class="kd">var</span><span class="p">=</span><span class="nx">install_result</span>

</code></pre></td></tr></table>
</div>
</div><p><strong>执行</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># ansible-playbook  myplaybook3.yml

PLAY [a play example] ***************************************************************************************************************************************************************

TASK [Gathering Facts] **************************************************************************************************************************************************************
ok: [192.168.122.131]
ok: [192.168.122.129]

TASK [install nginx package] ********************************************************************************************************************************************************
ok: [192.168.122.129]
ok: [192.168.122.131]
// 打印软件包安装结果
TASK [print result] *****************************************************************************************************************************************************************
ok: [192.168.122.129] =&gt; {
    &#34;install_result&#34;: {
        &#34;changed&#34;: false,
        &#34;msg&#34;: &#34;&#34;,
        &#34;rc&#34;: 0,
        &#34;results&#34;: [
            &#34;nginx-1.12.1-1.el6.ngx.x86_64 providing nginx is already installed&#34;
        ]
    }
}
ok: [192.168.122.131] =&gt; {
    &#34;install_result&#34;: {
        &#34;changed&#34;: false,
        &#34;msg&#34;: &#34;&#34;,
        &#34;rc&#34;: 0,
        &#34;results&#34;: [
            &#34;nginx-1.12.2-1.el6.ngx.x86_64 providing nginx is already installed&#34;
        ]
    }
}

PLAY RECAP **************************************************************************************************************************************************************************
192.168.122.129            : ok=3    changed=0    unreachable=0    failed=0
192.168.122.131            : ok=3    changed=0    unreachable=0    failed=0

</code></pre></td></tr></table>
</div>
</div><h5 id="heading-6">变量优先级</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">目前介绍了全局变量、剧本变量、资产变量、Facts变量及注册变量。其中Facts变量不需要人为去声明、赋值；注册变量只需通过关键字register去声明，而不需要赋值。而全局变量、剧本变量及资产变量则完全需要人为的去声明、赋值。变量的优先权讨论，也将着重从这三类变量去分析。

</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">假如在使用过程中，我们同时在全局变量、剧本变量及资产变量声明了同一个变量名，那么哪一个优先级最高呢?
下面我们将以实验的形式去验证变量的优先级

</code></pre></td></tr></table>
</div>
</div><p><strong>环境准备</strong></p>
<p>1、定义一份资产、且定义了资产变量user</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">[web-servers]
192.168.122.129
192.168.122.131

[web-servers:vars]
user=tomcat

</code></pre></td></tr></table>
</div>
</div><p>2、编写一份PlayBook、同样定义剧本变量user</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">---
- name: test variable priority
  hosts: all
  remote_user: root
  vars:
    user: mysql
  tasks:
    - name: print the user value
      debug: msg=&#39;the user value is {{ user }}&#39;

</code></pre></td></tr></table>
</div>
</div><p><strong>验证测试</strong></p>
<p><strong>同时使用全局变量、剧本变量、资产变量</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">当变量user同时定义在全局变量、剧本变量及资产变量中时，全局变量的优先级最高。

</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># ansible-playbook priority.yml -e &#34;user=www&#34;

PLAY [a play example] ***************************************************************************************************************************************************************

TASK [Gathering Facts] **************************************************************************************************************************************************************
ok: [192.168.122.131]
ok: [192.168.122.129]

// 打印的 user 值 为www , 全局变量生效
TASK [print the user value] *********************************************************************************************************************************************************
ok: [192.168.122.129] =&gt; {
    &#34;msg&#34;: &#34;the user value is www&#34;
}
ok: [192.168.122.131] =&gt; {
    &#34;msg&#34;: &#34;the user value is www&#34;
}

PLAY RECAP **************************************************************************************************************************************************************************
192.168.122.129            : ok=2    changed=0    unreachable=0    failed=0
192.168.122.131            : ok=2    changed=0    unreachable=0    failed=0

</code></pre></td></tr></table>
</div>
</div><p><strong>同时使用剧本变量和资产变量</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">取消全局变量，发现剧本变量的优先级要高于资产变量的优先级。

</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># ansible-playbook priority.yml

PLAY [a play example] ***************************************************************************************************************************************************************

TASK [Gathering Facts] **************************************************************************************************************************************************************
ok: [192.168.122.129]
ok: [192.168.122.131]
// 打印的 user 值 为mysql , 剧本变量生效
TASK [print the user value] *********************************************************************************************************************************************************
ok: [192.168.122.129] =&gt; {
    &#34;msg&#34;: &#34;the user value is mysql&#34;
}
ok: [192.168.122.131] =&gt; {
    &#34;msg&#34;: &#34;the user value is mysql&#34;
}

PLAY RECAP **************************************************************************************************************************************************************************
192.168.122.129            : ok=2    changed=0    unreachable=0    failed=0
192.168.122.131            : ok=2    changed=0    unreachable=0    failed=0

</code></pre></td></tr></table>
</div>
</div><p><strong>只是用资产变量的情况</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">不使用全局变量、且注释掉剧本变量后，资产变量才最终生效。

</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">---
- name: test variable priority
  hosts: all
  remote_user: root
  #vars:
  #  user: mysql
  tasks:
    - name: print the user value
      debug: msg=&#39;the user value is {{ user }}&#39;

</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># ansible-playbook priority.yml

PLAY [a play example] ***************************************************************************************************************************************************************

TASK [Gathering Facts] **************************************************************************************************************************************************************
ok: [192.168.122.129]
ok: [192.168.122.131]

// 打印的 user 值 为tomcat , 资产变量生效。
TASK [print the user value] *********************************************************************************************************************************************************
ok: [192.168.122.129] =&gt; {
    &#34;msg&#34;: &#34;the user value is tomcat&#34;
}
ok: [192.168.122.131] =&gt; {
    &#34;msg&#34;: &#34;the user value is tomcat&#34;
}

PLAY RECAP **************************************************************************************************************************************************************************
192.168.122.129            : ok=2    changed=0    unreachable=0    failed=0
192.168.122.131            : ok=2    changed=0    unreachable=0    failed=0

</code></pre></td></tr></table>
</div>
</div><p><strong>变量优先级结论</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">当一个变量同时在全局变量、剧本变量和资产变量中定义时，优先级最高的是全局变量；其次是剧本变量；最后才是资产变量。

</code></pre></td></tr></table>
</div>
</div>
    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">Joken</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2019-12-25 20:14
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/ansible/">ansible</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/ansible/ansible_6_ansible%E4%BB%BB%E5%8A%A1%E6%8E%A7%E5%88%B6/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Ansible_6_ansible任务控制</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/ansible/ansible_4_playbook%E5%89%A7%E6%9C%AC/">
            <span class="next-text nav-default">Ansible_4_playbook剧本</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:your@email.com" class="iconfont icon-email" title="email"></a>
      <a href="http://localhost:1313" class="iconfont icon-google" title="google"></a>
      <a href="https://github.com/jiaopanxin/jiaopanxin.github.io" class="iconfont icon-github" title="github"></a>
      <a href="http://localhost:1313" class="iconfont icon-weibo" title="weibo"></a>
      <a href="http://localhost:1313" class="iconfont icon-zhihu" title="zhihu"></a>
      <a href="http://localhost:1313" class="iconfont icon-douban" title="douban"></a>
      <a href="http://localhost:1313" class="iconfont icon-pocket" title="pocket"></a>
      <a href="http://localhost:1313" class="iconfont icon-tumblr" title="tumblr"></a>
      <a href="http://localhost:1313" class="iconfont icon-instagram" title="instagram"></a>
      <a href="http://localhost:1313" class="iconfont icon-gitlab" title="gitlab"></a>
      <a href="http://localhost:1313" class="iconfont icon-bilibili" title="bilibili"></a>
  <a href="https://jiaopanxin.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> 本站总访问量 <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次 </span>
      <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> 本站总访客数 <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 人 </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2019 - 
    2020
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Joken</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>
    <script type="text/javascript" src="/lib/timeago/timeago-3.0.2.min.js"></script>
    <script type="text/javascript" src="/lib/timeago/timeago.locales-3.0.2.min.js"></script>
  <script><!-- NOTE: timeago.js uses the language code format like "zh_CN" (underscore and case sensitive) -->
    var languageCode = "zh-CN".replace(/-/g, '_').replace(/_(.*)/, function ($0, $1) {return $0.replace($1, $1.toUpperCase());});
    timeago().render(document.querySelectorAll('.timeago'), languageCode);
    timeago.cancel();  
  </script>
<script type="text/javascript" src="/dist/even.26188efa.min.js"></script>








</body>
</html>
